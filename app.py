import streamlit as st
import pandas as pd

# 1. í˜ì´ì§€ ì„¤ì •
st.set_page_config(page_title="í›ˆí”„ë¡œ ì¿ íŒ¡ ê´‘ê³  ë¶„ì„ê¸°", layout="wide")
st.title("ğŸ“Š ì‡¼í¬íŠ¸ë¦¬ í›ˆí”„ë¡œ ì¿ íŒ¡ ê´‘ê³  ì„±ê³¼ ë¶„ì„ê¸°")
st.markdown("ì¿ íŒ¡ ë³´ê³ ì„œë¥¼ ì—…ë¡œë“œí•˜ë©´ í›ˆí”„ë¡œì˜ ì •ë°€ ìš´ì˜ ì „ëµì´ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.")

# --- 2. ì‚¬ì´ë“œë°”: ìˆ˜ìµì„± ê³„ì‚°ì„ ìœ„í•œ ì…ë ¥ì°½ ì¶”ê°€ ---
st.sidebar.header("ğŸ’° ë§ˆì§„ ê³„ì‚° ì„¤ì •")
unit_price = st.sidebar.number_input("ìƒí’ˆ íŒë§¤ê°€ (ì›)", min_value=0, value=0, step=100)
coupon_discount = st.sidebar.number_input("ì¿ í°/ì¦‰ì‹œí• ì¸ì•¡ (ì›)", min_value=0, value=10000, step=100)
unit_cost = st.sidebar.number_input("ì›ê°€ + ìˆ˜ìˆ˜ë£Œ ë“± ì§€ì¶œ (ì›)", min_value=0, value=0, step=100)

# ê°œë‹¹ ë§ˆì§„ ê³„ì‚°
net_unit_margin = unit_price - coupon_discount - unit_cost
st.sidebar.divider()
st.sidebar.write(f"**ğŸ’¡ ê°œë‹¹ ì˜ˆìƒ ë§ˆì§„:** {net_unit_margin:,.0f}ì›")

# 3. íŒŒì¼ ì—…ë¡œë“œ
uploaded_file = st.file_uploader("ë³´ê³ ì„œ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš” (CSV ë˜ëŠ” XLSX)", type=['csv', 'xlsx'])

if uploaded_file is not None:
    try:
        # íŒŒì¼ ì½ê¸°
        if uploaded_file.name.endswith('.csv'):
            df = pd.read_csv(uploaded_file)
        else:
            df = pd.read_excel(uploaded_file, engine='openpyxl')

        # ì»¬ëŸ¼ëª… ëŒ€ì‘ (14ì¼/1ì¼ ê¸°ì¤€)
        col_qty = 'ì´ íŒë§¤ìˆ˜ëŸ‰(14ì¼)' if 'ì´ íŒë§¤ìˆ˜ëŸ‰(14ì¼)' in df.columns else 'ì´ íŒë§¤ìˆ˜ëŸ‰(1ì¼)'
        col_rev = 'ì´ ì „í™˜ë§¤ì¶œì•¡(14ì¼)' if 'ì´ ì „í™˜ë§¤ì¶œì•¡(14ì¼)' in df.columns else 'ì´ ì „í™˜ë§¤ì¶œì•¡(1ì¼)'

        # 4. ë°ì´í„° ìš”ì•½ ë¶„ì„
        target_cols = {'ë…¸ì¶œìˆ˜': 'sum', 'í´ë¦­ìˆ˜': 'sum', 'ê´‘ê³ ë¹„': 'sum', col_qty: 'sum', col_rev: 'sum'}
        summary = df.groupby('ê´‘ê³  ë…¸ì¶œ ì§€ë©´').agg(target_cols).reset_index()
        summary.columns = ['ì§€ë©´', 'ë…¸ì¶œìˆ˜', 'í´ë¦­ìˆ˜', 'ê´‘ê³ ë¹„', 'íŒë§¤ìˆ˜ëŸ‰', 'ë§¤ì¶œì•¡']

        # ì§€í‘œ ê³„ì‚°
        summary['í´ë¦­ë¥ (CTR)'] = (summary['í´ë¦­ìˆ˜'] / summary['ë…¸ì¶œìˆ˜']).fillna(0)
        summary['êµ¬ë§¤ì „í™˜ìœ¨(CVR)'] = (summary['íŒë§¤ìˆ˜ëŸ‰'] / summary['í´ë¦­ìˆ˜']).fillna(0)
        summary['CPC'] = (summary['ê´‘ê³ ë¹„'] / summary['í´ë¦­ìˆ˜']).fillna(0).astype(int)
        summary['ROAS'] = (summary['ë§¤ì¶œì•¡'] / summary['ê´‘ê³ ë¹„']).fillna(0)
        
        # [ìˆ˜ìµì„± ì§€í‘œ ì¶”ê°€]
        summary['ì‹¤ì§ˆìˆœì´ìµ'] = (summary['íŒë§¤ìˆ˜ëŸ‰'] * net_unit_margin) - summary['ê´‘ê³ ë¹„']

        # ì „ì²´ í•©ê³„ ê³„ì‚°
        tot = summary.sum(numeric_only=True)
        total_data = {
            'ì§€ë©´': 'ğŸ¢ ì „ì²´ í•©ê³„',
            'ë…¸ì¶œìˆ˜': tot['ë…¸ì¶œìˆ˜'], 'í´ë¦­ìˆ˜': tot['í´ë¦­ìˆ˜'], 'ê´‘ê³ ë¹„': tot['ê´‘ê³ ë¹„'],
            'íŒë§¤ìˆ˜ëŸ‰': tot['íŒë§¤ìˆ˜ëŸ‰'], 'ë§¤ì¶œì•¡': tot['ë§¤ì¶œì•¡'],
            'í´ë¦­ë¥ (CTR)': tot['í´ë¦­ìˆ˜'] / tot['ë…¸ì¶œìˆ˜'] if tot['ë…¸ì¶œìˆ˜'] > 0 else 0,
            'êµ¬ë§¤ì „í™˜ìœ¨(CVR)': tot['íŒë§¤ìˆ˜ëŸ‰'] / tot['í´ë¦­ìˆ˜'] if tot['í´ë¦­ìˆ˜'] > 0 else 0,
            'CPC': int(tot['ê´‘ê³ ë¹„'] / tot['í´ë¦­ìˆ˜']) if tot['í´ë¦­ìˆ˜'] > 0 else 0,
            'ROAS': tot['ë§¤ì¶œì•¡'] / tot['ê´‘ê³ ë¹„'] if tot['ê´‘ê³ ë¹„'] > 0 else 0,
            'ì‹¤ì§ˆìˆœì´ìµ': (tot['íŒë§¤ìˆ˜ëŸ‰'] * net_unit_margin) - tot['ê´‘ê³ ë¹„']
        }
        total_row = pd.DataFrame([total_data])
        display_df = pd.concat([summary, total_row], ignore_index=True)

        # 5. ì„±ê³¼ ìš”ì•½ ëŒ€ì‹œë³´ë“œ ì¶œë ¥
        st.subheader("ğŸ“Œ í•µì‹¬ ì„±ê³¼ ì§€í‘œ")
        m1, m2, m3, m4 = st.columns(4)
        m1.metric("ìµœì¢… ì‹¤ì§ˆ ìˆœì´ìµ", f"{total_data['ì‹¤ì§ˆìˆœì´ìµ']:,.0f}ì›")
        m2.metric("ì´ ê´‘ê³ ë¹„", f"{tot['ê´‘ê³ ë¹„']:,.0f}ì›")
        m3.metric("í‰ê·  ROAS", f"{total_data['ROAS']:.2%}")
        m4.metric("íŒë§¤ìˆ˜ëŸ‰", f"{tot['íŒë§¤ìˆ˜ëŸ‰']:,.0f}ê°œ")

        st.dataframe(display_df.style.format({
            'ë…¸ì¶œìˆ˜': '{:,.0f}', 'í´ë¦­ìˆ˜': '{:,.0f}', 'ê´‘ê³ ë¹„': '{:,.0f}ì›', 
            'íŒë§¤ìˆ˜ëŸ‰': '{:,.0f}', 'ë§¤ì¶œì•¡': '{:,.0f}ì›', 'CPC': '{:,.0f}ì›',
            'í´ë¦­ë¥ (CTR)': '{:.2%}', 'êµ¬ë§¤ì „í™˜ìœ¨(CVR)': '{:.2%}', 'ROAS': '{:.2%}',
            'ì‹¤ì§ˆìˆœì´ìµ': '{:,.0f}ì›'
        }), use_container_width=True)

        # 6. ê´‘ê³ ë¹„ ë„ë‘‘ í‚¤ì›Œë“œ
        st.divider()
        st.subheader("âœ‚ï¸ ëˆë¨¹ëŠ” í‚¤ì›Œë“œ (ì œì™¸ ëŒ€ìƒ ì œì•ˆ-ë©”ì¸í‚¤ì›Œë“œëŠ” ì œì™¸ê¸ˆì§€)")
        
        if 'í‚¤ì›Œë“œ' in df.columns:
            kw_agg = df.groupby('í‚¤ì›Œë“œ').agg({'ê´‘ê³ ë¹„': 'sum', col_qty: 'sum'}).reset_index()
            bad_mask = (kw_agg['ê´‘ê³ ë¹„'] > 0) & (kw_agg[col_qty] == 0)
            bad_kws = kw_agg[bad_mask].sort_values(by='ê´‘ê³ ë¹„', ascending=False)

            if not bad_kws.empty:
                total_waste_spend = bad_kws['ê´‘ê³ ë¹„'].sum()
                st.error(f"âš ï¸ í˜„ì¬ ì´ **{len(bad_kws)}ê°œ**ì˜ í‚¤ì›Œë“œê°€ ë§¤ì¶œ ì—†ì´ **{total_waste_spend:,.0f}ì›**ì˜ ê´‘ê³ ë¹„ë¥¼ ì†Œì§„í–ˆìŠµë‹ˆë‹¤.")
                bad_names = bad_kws['í‚¤ì›Œë“œ'].astype(str).tolist()
                copy_text = ", ".join(bad_names)
                st.text_area("ğŸ“‹ ì•„ë˜ í‚¤ì›Œë“œë¥¼ ë³µì‚¬ í›„ 'ì œì™¸ í‚¤ì›Œë“œ'ì— ë“±ë¡í•˜ì„¸ìš”:", value=copy_text, height=120)
                st.dataframe(bad_kws.style.format({'ê´‘ê³ ë¹„': '{:,.0f}ì›', col_qty: '{:,.0f}ê°œ'}), use_container_width=True)
            else:
                st.success("ğŸ‰ ëª¨ë“  ì§‘í–‰ í‚¤ì›Œë“œì—ì„œ ë§¤ì¶œì´ ë°œìƒí•˜ê³  ìˆìŠµë‹ˆë‹¤!")
        else:
            st.info("ğŸ’¡ 'í‚¤ì›Œë“œ ë³´ê³ ì„œ'ë¥¼ ì—…ë¡œë“œí•˜ì‹œë©´ ìƒì„¸ ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.")

        # 7. í›ˆí”„ë¡œì˜ ì •ë°€ ìš´ì˜ ì œì•ˆ (ìš”ì²­í•˜ì‹  ì½”ë“œë¡œ êµì²´ë¨)
        st.divider()
        st.subheader("ğŸ’¡ í›ˆí”„ë¡œì˜ ì •ë°€ ìš´ì˜ ì œì•ˆ")
        
        t_perf = total_row.iloc[0]
        col1, col2, col3 = st.columns(3)

        with col1:
            st.info("ğŸ–¼ï¸ **CTR ë¶„ì„ (ì¸ë„¤ì¼)**")
            ctr_val = t_perf['í´ë¦­ë¥ (CTR)']
            st.write(f"- **í˜„ì¬ CTR: {ctr_val:.2%}**")
            if ctr_val < 0.01:
                st.write("- **ë¶„ì„**: ë…¸ì¶œ ëŒ€ë¹„ ê³ ê°ì˜ ì„ íƒì„ ë°›ì§€ ëª»í•˜ê³  ìˆìŠµë‹ˆë‹¤.")
                st.write("- **ì•¡ì…˜**: ì¸ë„¤ì¼ ë°°ê²½ ì œê±°, ë‹¤ë¥¸ ì´ë¯¸ì§€ í™œìš©, í˜¹ì€ ìƒí’ˆëª…ì„ ë³€ê²½ì„ ê³ ë ¤í•´ë³´ì„¸ìš”.")
            else:
                st.write("- **ë¶„ì„**: ì‹œê°ì  ì†Œêµ¬ë ¥ì´ ì¶©ë¶„í•©ë‹ˆë‹¤. í˜„ì¬ ì´ë¯¸ì§€ë¥¼ ìœ ì§€í•˜ë©° ìœ ì…ëŸ‰ í™•ëŒ€ì— ì§‘ì¤‘í•˜ì„¸ìš”.")

        with col2:
            st.warning("ğŸ›’ **CVR ë¶„ì„ (ìƒì„¸í˜ì´ì§€)**")
            cvr_val = t_perf['êµ¬ë§¤ì „í™˜ìœ¨(CVR)']
            st.write(f"- **í˜„ì¬ CVR: {cvr_val:.2%}**")
            if cvr_val < 0.05:
                st.write("- **ë¶„ì„**: ë“¤ì–´ì˜¨ ê³ ê°ì´ ê·¸ëƒ¥ ë‚˜ê°‘ë‹ˆë‹¤. ìƒì„¸í˜ì´ì§€ ì„¤ë“ë ¥ì´ ë¶€ì¡±í•˜ê±°ë‚˜ ë¦¬ë·° ì‹ ë¢°ë„ê°€ ë‚®ìŠµë‹ˆë‹¤.")
                st.write("- **ì•¡ì…˜**: ìƒë‹¨ 3ì´ˆ ì•ˆì— í•µì‹¬ í˜œíƒ(ë¬´ë£Œë°°ì†¡, íŠ¹ê°€, ì¦ì • ë“±)ì„ ë°°ì¹˜í•˜ê³  ë² ìŠ¤íŠ¸ ë¦¬ë·°ë¥¼ ìƒë‹¨ì— ë…¸ì¶œí•˜ì„¸ìš”.")
            else:
                st.write("- **ë¶„ì„**: ìƒì„¸í˜ì´ì§€ê°€ ë§¤ìš° í›Œë¥­í•©ë‹ˆë‹¤. ìœ ì… ë‹¨ê°€(CPC)ë§Œ ê´€ë¦¬í•˜ë©´ í° ìˆ˜ìµì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.")

        with col3:
            st.error("ğŸ’° **ROAS ë¶„ì„ (ìˆ˜ìµì„± ë° ëª©í‘œì„¤ì •)**")
            roas_val = t_perf['ROAS']
            st.write(f"- **í˜„ì¬ ROAS: {roas_val:.2%}**")
            
            if roas_val < 2.0:
                st.write("ğŸ†˜ **[ì‹¬ê°] ì†ì‹¤ êµ¬ê°„**")
                st.write("- **ë¶„ì„**: ê´‘ê³ ë¹„ ì†Œì§„ì´ ë„ˆë¬´ ë¹ ë¦…ë‹ˆë‹¤. í˜„ì¬ ì ì ìƒíƒœì¼ í™•ë¥ ì´ ë§¤ìš° ë†’ìŠµë‹ˆë‹¤.")
                st.write("- **ëª©í‘œìˆ˜ìµë¥  ì¡°ì •**: **í˜„ì¬ ì„¤ì •ê°’ì—ì„œ 50~100%p ì¦‰ì‹œ ìƒí–¥**í•˜ì„¸ìš”. (ë…¸ì¶œì„ ì¤„ì—¬ ëˆ„ìˆ˜ë¥¼ ë§‰ì•„ì•¼ í•¨)")
                st.write("- **ìš´ì˜**: ì„±ê³¼ ì—†ëŠ” í‚¤ì›Œë“œë¥¼ ì¦‰ì‹œ ì œì™¸í•˜ê³ , íš¨ìœ¨ì´ ê²€ì¦ëœ í‚¤ì›Œë“œì—ë§Œ ì§‘ì¤‘í•˜ì„¸ìš”.")
            elif 2.0 <= roas_val < 4.0:
                st.write("âš ï¸ **[ì£¼ì˜] ì €íš¨ìœ¨ êµ¬ê°„**")
                st.write("- **ë¶„ì„**: ë§¤ì¶œì€ ë°œìƒí•˜ë‚˜ ì‹¤ì§ˆ ìˆœìˆ˜ìµì€ ë§¤ìš° ì ì€ ìƒíƒœì…ë‹ˆë‹¤.")
                st.write("- **ëª©í‘œìˆ˜ìµë¥  ì¡°ì •**: **í˜„ì¬ ì„¤ì •ê°’ì—ì„œ 20~30%p ìƒí–¥**í•˜ì—¬ ë³´ìˆ˜ì ìœ¼ë¡œ ìš´ì˜í•˜ì„¸ìš”.")
                st.write("- **ìš´ì˜**: íš¨ìœ¨ì´ ë‚®ì€ ê²€ìƒ‰ ì§€ë©´(ê¸°íƒ€ ì§€ë©´) ë¹„ì¤‘ì„ ë‚®ì¶”ê³  ë©”ì¸ íƒ€ê²Ÿì— ì§‘ì¤‘í•˜ì„¸ìš”.")
            elif 4.0 <= roas_val < 6.0:
                st.write("âœ… **[ì•ˆì •] ìˆ˜ìµ ìœ ì§€ êµ¬ê°„**")
                st.write("- **ë¶„ì„**: ìˆ˜ìµê³¼ ë§¤ì¶œ ë³¼ë¥¨ì˜ ë°¸ëŸ°ìŠ¤ê°€ ì¢‹ìŠµë‹ˆë‹¤.")
                st.write("- **ëª©í‘œìˆ˜ìµë¥  ì¡°ì •**: **í˜„ ì„¤ì •ì„ ìœ ì§€**í•˜ê±°ë‚˜, ë§¤ì¶œ í™•ëŒ€ë¥¼ ìœ„í•´ 10%pì”© ë¯¸ì„¸ í•˜í–¥ ì¡°ì •ì„ ì‹œë„í•˜ì„¸ìš”.")
                st.write("- **ìš´ì˜**: ê²½ìŸì‚¬ ë™í–¥ì„ ì²´í¬í•˜ë©° ì ìœ ìœ¨ì„ ëºê¸°ì§€ ì•Šë„ë¡ ê´€ë¦¬í•˜ì„¸ìš”.")
            else:
                st.write("ğŸš€ **[í™•ì¥] ê³ íš¨ìœ¨ ì„±ì¥ êµ¬ê°„**")
                st.write("- **ë¶„ì„**: ìˆ˜ìµì„±ì´ ë§¤ìš° ë›°ì–´ë‚©ë‹ˆë‹¤. ë” í° ë§¤ì¶œì„ ë§Œë“¤ ê¸°íšŒì…ë‹ˆë‹¤.")
                st.write("- **ëª©í‘œìˆ˜ìµë¥  ì¡°ì •**: **í˜„ì¬ ì„¤ì •ê°’ì—ì„œ 20~50%p ê³¼ê°íˆ í•˜í–¥**í•˜ì„¸ìš”. (ë…¸ì¶œì„ ëŠ˜ë ¤ ë³¼ë¥¨ì„ í‚¤ì›Œì•¼ í•¨)")
                st.write("- **ìš´ì˜**: ì˜ˆì‚°ì„ ì¦ì•¡í•˜ê³  ë…¸ì¶œ ìˆœìœ„ë¥¼ ìƒë‹¨ìœ¼ë¡œ ëŒì–´ì˜¬ë ¤ ì‹œì¥ì„ ì„ ì í•˜ì„¸ìš”.")

    except Exception as e:
        st.error(f"ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")

# í‘¸í„°
st.divider()
st.markdown("<div style='text-align: center;'><a href='https://hoonpro.liveklass.com/' target='_blank'>ğŸ  ì‡¼í¬íŠ¸ë¦¬ í›ˆí”„ë¡œ í™ˆí˜ì´ì§€ ë°”ë¡œê°€ê¸°</a></div>", unsafe_allow_html=True)